<head>
    <%- include('./partials/bootstrap.ejs') %>
    <style>
        .otp{
            border: solid 2px;
            border-radius: 25px;
            width: 300px;
            height: 300px;
            background-color: white;
        }
        body{
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgb(239, 239, 239);
        }
    </style>
</head>
<body>
    <% if(locals.otperr){ %>
        <dialog open style="background-color: black;color:white;position: absolute;top: 50vh;border-radius: 10px;">
            <p>wrong OTP</p>
            <form method="dialog">
                <button>OK</button>
            </form>
        </dialog>
    <% }%>


    <div class="otp" style="display: flex;justify-content: center;align-items: center;">
        <form action="<%= otpaddress %>"  onsubmit="otpcheck(event)">
            <div style="display: flex;flex-direction: column;gap:10px;align-items: center;">
                <h1 style="text-align: center;">Enter OTP</h1>
                <input style="height: 30px;border-radius: 7px;" type="password" name="otp" id="otp" placeholder="otp">
                <div style="display: flex;justify-content: space-between;width: 100%;align-items: center;">
                    <p id="time" style="color: rgb(17, 0, 255);margin: 0;">resend OTP in 00:<%= otpwait %></p>
                    <button type="button" onclick="handleresend()" style="display: none;" id="resend" disabled>resend</button>
                </div>
                <button  style="border-radius: 8px;width: 80px;" type="submit">submit</button>
            </div>
        </form>
    </div>
    <script>
        function timer(a,b) {
            let t = Math.floor(a)-1
            const resend = document.querySelector('#resend')
            const time = document.querySelector('#time')
            if(b){
                resend.style.display = 'none'
                time.innerHTML = `resend OTP in 00:${t+1}`
            }
            time.style.display = 'block'
            const timer = setInterval(() => {
                time.innerHTML = `resend OTP in 00:${t}`
                t--
                if (t < 0) {
                    clearInterval(timer)
                    time.style.display='none'
                    resend.style.display = 'block'
                    resend.disabled = false
                }
            }, 1000);
        }
        timer(<%= otpwait %>)

        async function handleresend(){
            const resend = document.querySelector('#resend')
            resend.disabled = true
            const data=await fetch('/otpverification/sendotp/<%= id%>')
            const response=await data.json()
            timer(response.wait,true)
        }

        async function otpcheck(event){
            event.preventDefault()
            const otpinput=document.querySelector('#otp').value
            if(isNaN(otpinput) || otpinput.length==4){
                const response = await fetch('/otpverification/user/<%= id%>', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        otp: otpinput
                    })
                })
                const check = await response.json()
                console.log(check)
                if (check.otp) {
                    window.location.href = '/'
                } else {
                    alert('incrroct otp')
                }
            }else{
                alert('OTP should be 4 digit number')
            }
        }

    </script>
</body>
